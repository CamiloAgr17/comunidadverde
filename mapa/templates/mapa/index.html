<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <link rel="stylesheet" href="{% static 'mapa/css/style.css' %}">

    <title>Mapa de Centros</title>
    <!-- MapLibre CSS/JS -->
    <script src='https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.js'></script>
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.css' />

</head>

    <header class="main-header">
        <div class="header-content">
            <a href="{% url 'feed' %}">
                <img src="{% static 'images/logo_icont.png' %}" alt="LOGO">
            </a>
            <!-- Buscador -->
             <div class="buscador">
                <div class="buscador__input-wrapper">
                    <input type="text" id="buscador" placeholder="Buscar organización..." class="buscador__input" />
                    <ul id="lista-sugerencias" class="sugerencias-lista"></ul>
                </div>
                 <button class="buscador__button" type="button">
                    <svg class="buscador__icon" aria-hidden="true" viewBox="0 0 24 24">
                    <g>
                        <path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path>
                    </g>
                    </svg>
                 </button>
            </div>
            <div class="org_b">
                <button id="btn-cercanas" class="button">
                    <svg class="svgIcon" viewBox="0 0 512 512" height="1em" xmlns="http://www.w3.org/2000/svg"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm50.7-186.9L162.4 380.6c-19.4 7.5-38.5-11.6-31-31l55.5-144.3c3.3-8.5 9.9-15.1 18.4-18.4l144.3-55.5c19.4-7.5 38.5 11.6 31 31L325.1 306.7c-3.2 8.5-9.9 15.1-18.4 18.4zM288 256a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"></path></svg>
                        Organizaciones cercanas a mí
                </button>
            </div>
        </div>
    </header>

    <body>
        <div id="map"></div>

        <script>
            const organizaciones = {{ organizaciones_json|safe }};
            const inputBuscador = document.getElementById('buscador');
            const listaSugerencias = document.getElementById('lista-sugerencias');

            inputBuscador.addEventListener('input', () => {
            const texto = inputBuscador.value.toLowerCase().trim();
            if (!texto) {
                listaSugerencias.style.display = 'none';
                listaSugerencias.innerHTML = '';
                return;
            }

            // Filtrar organizaciones por nombre que contenga el texto
            const resultados = organizaciones.filter(org =>
                org.nombre.toLowerCase().includes(texto)
            );

            if (resultados.length === 0) {
                listaSugerencias.style.display = 'none';
                listaSugerencias.innerHTML = '';
                return;
            }

            // Mostrar la lista con los resultados
            listaSugerencias.innerHTML = resultados
                .map(
                org =>
                    `<li data-longitud="${org.longitud}" data-latitud="${org.latitud}">${org.nombre}</li>`
                )
                .join('');
            listaSugerencias.style.display = 'block';
            });

            listaSugerencias.addEventListener('click', e => {
            if (e.target.tagName.toLowerCase() === 'li') {
                const lat = parseFloat(e.target.dataset.latitud);
                const lon = parseFloat(e.target.dataset.longitud);
                const nombre = e.target.textContent;

                // Vuela a la ubicación
                map.flyTo({
                center: [lon, lat],
                zoom: 14, // zoom deseado
                essential: true,
                });

                // Opcional: cerrar la lista y limpiar el input
                listaSugerencias.style.display = 'none';
                listaSugerencias.innerHTML = '';
                inputBuscador.value = nombre;
            }
            });

            document.addEventListener('click', (event) => {
            const buscador = document.querySelector('.buscador');
            if (!buscador.contains(event.target)) {
                listaSugerencias.style.display = 'none';
            }
            });
        </script>

        <script>
            const estilos = {
                streets: 'https://api.maptiler.com/maps/streets/style.json?key=sze1ZxSVTfvtlbFXog86',
                satelite: 'https://api.maptiler.com/maps/hybrid/style.json?key=sze1ZxSVTfvtlbFXog86',
            };

            const map = new maplibregl.Map({
                container: 'map',
                style: estilos.streets,
                center: [-79.5, 9.0],
                zoom: 12
            });

            map.addControl(new maplibregl.NavigationControl());

            const geolocate = new maplibregl.GeolocateControl({
                positionOptions: { enableHighAccuracy: true },
                trackUserLocation: true,
                showUserHeading: true
            });
            map.addControl(geolocate);

            let centradoInicial = false;

            map.on('load', () => {
                geolocate.trigger();

                geolocate.on('geolocate', (event) => {
                    if (!centradoInicial) {
                        centradoInicial = true;

                        const { longitude, latitude } = event.coords;

                        map.flyTo({
                            center: [longitude, latitude],
                            zoom: 14,
                            essential: true
                        });

                        new maplibregl.Marker({ color: '#262f4a' })
                            .setLngLat([longitude, latitude])
                            .addTo(map);
                    }
                });
            });

            // Cambio de estilo
            // document.getElementById('styleSelector').addEventListener('change', function (e) {
            //     const estiloSeleccionado = e.target.value;
            //     map.setStyle(estilos[estiloSeleccionado]);
            // });

            // Marcadores desde Django
            

            class ViewToggleControl {
                onAdd(map) {
                    this.map = map;

                    // Crear contenedor principal del control
                    this.container = document.createElement("div");
                    this.container.className = "maplibregl-ctrl maplibregl-ctrl-group custom-toggle-control";

                    // Botón principal
                    const toggleBtn = document.createElement("button");
                    toggleBtn.id = "toggleViewBtn";
                    toggleBtn.title = "Cambiar vista";

                    const icon = document.createElement("img");
                    icon.src = "{% static 'icons/map.png' %}";
                    icon.alt = "Toggle View";
                    toggleBtn.appendChild(icon);

                    this.container.appendChild(toggleBtn);

                    // Opciones (inicialmente ocultas)
                    const viewOptions = document.createElement("div");
                    viewOptions.className = "view-options hidden";
                    viewOptions.id = "viewOptions";

                    const options = [
                        { style: "streets", title: "Vista Calle", icon: "person.png" },
                        { style: "satelite", title: "Vista Satélite", icon: "satellite.png" }
                    ];

                    options.forEach(opt => {
                        const btn = document.createElement("button");
                        btn.setAttribute("data-style", opt.style);
                        btn.title = opt.title;

                        const img = document.createElement("img");
                        img.src = `{% static 'icons/' %}${opt.icon}`;;
                        img.alt = opt.title;

                        btn.appendChild(img);
                        viewOptions.appendChild(btn);
                    });

                    this.container.appendChild(viewOptions);

                    // Evento para mostrar/ocultar menú
                    toggleBtn.addEventListener("click", () => {
                        viewOptions.classList.toggle("hidden");
                    });

                    // Evento para cambiar estilo
                    viewOptions.querySelectorAll("[data-style]").forEach(btn => {
                        btn.addEventListener("click", () => {
                            const style = btn.getAttribute("data-style");
                            map.setStyle(estilos[style]);;
                            viewOptions.classList.add("hidden");
                        });
                    });

                    return this.container;
                }

                onRemove() {
                    this.container.remove();
                    this.map = undefined;
                }
            }

            map.addControl(new ViewToggleControl(), "top-right");

            organizaciones.forEach(org => {
                if (org.latitud && org.longitud) {
                    new maplibregl.Marker({ color: 'green' })
                        .setLngLat([org.longitud, org.latitud])
                        .setPopup(
                            new maplibregl.Popup().setHTML(`
                                <strong>${org.nombre}</strong><br/>
                                Dirección: ${org.direccion || 'No disponible'}<br/>
                                Teléfono: ${org.telefono || 'No disponible'}
                            `)
                        )
                        .addTo(map);
                }
            });

        </script>

        <div id="popup-cercanas" class="popup-cercanas">
            <h3 style="margin-top: 0;">Top 3 organizaciones cercanas</h3>
            <ul id="lista-cercanas" style="list-style: none; padding: 0; margin: 15px 0;"></ul>
            <button id="cerrar-popup" >
                Cerrar
            </button>
         </div>

        <!-- SCRIPT PARA ORG CERCANAS -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                function calcularDistancia(lat1, lon1, lat2, lon2) {
                    const R = 6371;
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLon = (lon2 - lon1) * Math.PI / 180;
                    const a = Math.sin(dLat / 2) ** 2 +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon / 2) ** 2;
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    return R * c;
                }

                function mostrarPopup() {
                    const popup = document.getElementById('popup-cercanas');
                    popup.style.display = "block";
                    popup.offsetHeight; // fuerza reflow
                    popup.style.opacity = "1";
                    popup.classList.add("popup-visible");
                }

                const btnCercanas = document.getElementById('btn-cercanas');

                btnCercanas.addEventListener('click', () => {
                    console.log("Organizaciones:", organizaciones);

                    if (!navigator.geolocation) {
                        alert('Tu navegador no soporta geolocalización.');
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(pos => {
                        const latUsuario = pos.coords.latitude;
                        const lonUsuario = pos.coords.longitude;

                        const top3 = [...organizaciones].map(org => {
                            const distancia = calcularDistancia(latUsuario, lonUsuario, org.latitud, org.longitud);
                            return { ...org, distancia };
                        }).sort((a, b) => a.distancia - b.distancia).slice(0, 3);

                        const lista = document.getElementById('lista-cercanas');
                        const popup = document.getElementById('popup-cercanas');
                        lista.innerHTML = ''; // limpiar

                        top3.forEach((org, i) => {
                            const li = document.createElement('li');
                            const btn = document.createElement('button');
                            btn.textContent = `${i + 1}. ${org.nombre} (${org.distancia.toFixed(2)} km)`;
                            btn.style.cssText = `
                                background-color: #e7e7e7;
                                border: none;
                                border-radius: 5px;
                                padding: 8px;
                                margin-bottom: 8px;
                                width: 100%;
                                text-align: left;
                                cursor: pointer;
                            `;

                            btn.addEventListener('click', () => {
                                // Cerrar popups previos
                                const popups = document.querySelectorAll('.maplibregl-popup');
                                popups.forEach(p => p.remove());

                                // Hacer flyTo con animación suave
                                map.flyTo({
                                    center: [org.longitud, org.latitud],
                                    zoom: 14,
                                    essential: true
                                });

                                // Asegurarse de que el flyTo termine antes de mostrar el popup
                                setTimeout(() => {
                                    new maplibregl.Popup()
                                        .setLngLat([org.longitud, org.latitud])
                                        .setHTML(`<strong>${org.nombre}</strong><br>Distancia aprox: ${org.distancia.toFixed(2)} km`)
                                        .addTo(map);
                                }, 1000); // espera 1 segundo antes de mostrar el popup

                                inputBuscador.value = org.nombre;
                                popup.style.display = 'none';
                            });

                            li.appendChild(btn);
                            lista.appendChild(li);
                        });

                        mostrarPopup();
                    }, err => {
                        alert('Error al obtener tu ubicación.');
                        console.error(err);
                    });
                });

                // Cerrar con botón
                document.getElementById('cerrar-popup').addEventListener('click', () => {
                    document.getElementById('popup-cercanas').style.display = 'none';
                });

                // Cerrar si se hace clic fuera
                document.addEventListener('click', (event) => {
                    const popup = document.getElementById('popup-cercanas');
                    const btnCercanas = document.getElementById('btn-cercanas');
                    const cerrarPopup = document.getElementById('cerrar-popup');

                    if (!popup.contains(event.target) && event.target !== btnCercanas && event.target !== cerrarPopup) {
                        popup.style.display = 'none';
                    }

                    const listaSugerencias = document.getElementById('lista-sugerencias');
                    const buscador = document.querySelector('.buscador');
                    if (buscador && listaSugerencias && !buscador.contains(event.target)) {
                        listaSugerencias.style.display = 'none';
                    }
                });
            });
        </script>
    </body>
</html>