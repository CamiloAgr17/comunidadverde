<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <link rel="stylesheet" href="{% static 'mapa/css/style.css' %}">

    <title>Mapa de Centros</title>
    <!-- MapLibre CSS/JS -->
    <script src='https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.js'></script>
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.css' />

</head>
<body>
    <!-- <h1>Centros de Reciclaje</h1>
    <select id="styleSelector">
        <option value="streets">Mapa Normal</option>
        <option value="satelite">Satélite</option>
    </select> -->
    <div id="map"></div>

    <script>
        const estilos = {
            streets: 'https://api.maptiler.com/maps/streets/style.json?key=sze1ZxSVTfvtlbFXog86',
            satelite: 'https://api.maptiler.com/maps/hybrid/style.json?key=sze1ZxSVTfvtlbFXog86',
        };

        const map = new maplibregl.Map({
            container: 'map',
            style: estilos.streets,
            center: [-79.5, 9.0],
            zoom: 12
        });

        map.addControl(new maplibregl.NavigationControl());

        const geolocate = new maplibregl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showUserHeading: true
        });
        map.addControl(geolocate);

        map.on('load', () => {
            geolocate.trigger(); // Intenta activarlo

            geolocate.on('geolocate', (event) => {
                const { longitude, latitude } = event.coords;

                console.log("Ubicación detectada:", latitude, longitude);

                map.flyTo({
                    center: [longitude, latitude],
                    zoom: 14,
                    essential: true
                });

                new maplibregl.Marker({ color: 'blue' })  // marcador azul
                    .setLngLat([longitude, latitude])
                    .addTo(map);
            });
        });

        // Cambio de estilo
        // document.getElementById('styleSelector').addEventListener('change', function (e) {
        //     const estiloSeleccionado = e.target.value;
        //     map.setStyle(estilos[estiloSeleccionado]);
        // });

        // Marcadores desde Django
        const centros = JSON.parse('{{ centros|safe|escapejs }}'.replaceAll("'", '"'));
        centros.forEach(centro => {
            new maplibregl.Marker()
                .setLngLat([centro.lng, centro.lat])
                .setPopup(
                    new maplibregl.Popup().setHTML(
                        `<strong>${centro.nombre}</strong><br>Materiales: ${centro.materiales}`
                    )
                )
                .addTo(map);
        });

        class ViewToggleControl {
            onAdd(map) {
                this.map = map;

                // Crear contenedor principal del control
                this.container = document.createElement("div");
                this.container.className = "maplibregl-ctrl maplibregl-ctrl-group custom-toggle-control";

                // Botón principal
                const toggleBtn = document.createElement("button");
                toggleBtn.id = "toggleViewBtn";
                toggleBtn.title = "Cambiar vista";

                const icon = document.createElement("img");
                icon.src = "{% static 'icons/map-icon.svg' %}";
                icon.alt = "Toggle View";
                toggleBtn.appendChild(icon);

                this.container.appendChild(toggleBtn);

                // Opciones (inicialmente ocultas)
                const viewOptions = document.createElement("div");
                viewOptions.className = "view-options hidden";
                viewOptions.id = "viewOptions";

                const options = [
                    { style: "streets-v2", title: "Vista Calle", icon: "street-view-icon.svg" },
                    { style: "satellite-v2", title: "Vista Satélite", icon: "satellite-icon.svg" }
                ];

                options.forEach(opt => {
                    const btn = document.createElement("button");
                    btn.setAttribute("data-style", opt.style);
                    btn.title = opt.title;

                    const img = document.createElement("img");
                    img.src = `{% static 'icons/${opt.icon}' %}`;
                    img.alt = opt.title;

                    btn.appendChild(img);
                    viewOptions.appendChild(btn);
                });

                this.container.appendChild(viewOptions);

                // Evento para mostrar/ocultar menú
                toggleBtn.addEventListener("click", () => {
                    viewOptions.classList.toggle("hidden");
                });

                // Evento para cambiar estilo
                viewOptions.querySelectorAll("[data-style]").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const style = btn.getAttribute("data-style");
                        map.setStyle(`https://api.maptiler.com/maps/${style}/style.json?key=sze1ZxSVTfvtlbFXog86`);
                        viewOptions.classList.add("hidden");
                    });
                });

                return this.container;
            }

            onRemove() {
                this.container.remove();
                this.map = undefined;
            }
        }

    </script>
</body>
</html>